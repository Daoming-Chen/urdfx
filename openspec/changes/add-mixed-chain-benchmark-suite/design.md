# Design: Mixed-Chain Benchmark Suite (MixKinBench)

## Context

用户已开发新的数值逆运动学(IK)求解器,目标是验证其在各种机械臂配置下的性能和鲁棒性。现有基准测试主要关注标准的 6-7 DOF 旋转关节机器人,缺乏对高 DOF 和混合关节类型的系统评估。

混合关节系统(旋转 + 移动)引入了以下挑战:
- **单位不一致**: 旋转关节使用弧度,移动关节使用米,导致雅可比矩阵的梯度缩放不同
- **工作空间复杂性**: 混合链产生非标准工作空间流形
- **求解器敏感性**: 数值优化算法可能对不同关节类型表现不同

## Goals / Non-Goals

**Goals**:
- 提供程序化生成任意 DOF (6-100) 混合关节串行链的能力
- 生成可验证的基准测试数据集(使用 FK oracle 确保正确性)
- 测量求解器在不同自由度和关节类型组合下的性能指标
- 支持冷启动、热启动、轨迹跟踪等多种 IK 场景
- 保持与现有 Google Benchmark 框架的兼容性

**Non-Goals**:
- 不支持并联机器人或闭链机构
- 不进行碰撞检测或任务空间约束测试
- 不生成实时可视化(可选的后处理可视化工具)
- 不替换现有的标准机器人基准测试(UR5, Panda)

## Decisions

### Decision 1: Python 作为数据生成工具

**选择**: 使用 Python + NumPy/Pinocchio 生成 URDF 和测试数据集

**理由**:
- Python 生态系统丰富,适合科学计算和数据处理
- Pinocchio 提供可靠的 FK oracle(或使用 urdfx 自身的 Python 绑定)
- 便于生成随机种子、参数扫描、数据序列化
- 不影响核心 C++ 库的依赖(仅作为开发工具)

**Alternatives considered**:
- C++ 直接生成: 实现复杂,缺乏灵活性,难以调试
- 手动创建 URDF: 无法扩展到 100 DOF,维护成本高

### Decision 2: 随机关节类型分布

**选择**: 使用随机概率 $P_{prism} \approx 0.2 - 0.3$ 生成混合链

**理由**:
- 真实机器人通常以旋转关节为主,少量移动关节
- 随机分布可覆盖多种拓扑结构
- 支持用户指定种子以实现可重复性

**Alternatives considered**:
- 固定模式 (R-P-R-P...): 缺乏多样性,无法测试非对称拓扑
- 全旋转或全移动: 退化为特殊情况,不体现混合挑战

### Decision 3: DH 参数 vs URDF 格式

**选择**: 生成标准 URDF 格式

**理由**:
- urdfx 库原生支持 URDF 解析
- URDF 是机器人领域的工业标准,便于与其他工具(RViz, PyBullet)集成
- 支持完整的几何信息(虽然基准测试不需要可视化网格)

**Alternatives considered**:
- DH 参数: 表达简洁但不通用,需要额外转换逻辑

### Decision 4: 基准测试指标

**选择的核心指标**:
1. **Success Rate** (%): $\|FK(q_{sol}) - T_{target}\| < \epsilon$
2. **Iterations per Solve**: 平均迭代次数
3. **Execution Time** (µs): 每次求解的平均时间
4. **Position Error** (mm): 成功解的平均位置误差
5. **Rotation Error** (deg): 成功解的平均旋转误差
6. **Joint Type Sensitivity**: 按旋转/移动关节分组的误差分析

**理由**: 这些指标直接反映求解器的收敛性、精度和效率

### Decision 5: Ground Truth 生成策略

**选择**: 使用 FK Oracle 生成测试用例

**流程**:
1. 随机采样关节向量 $q_{gt} \in \mathbb{R}^N$ (在关节限制内)
2. 计算目标位姿 $T_{target} = FK(q_{gt})$
3. 生成不同的初始猜测 $q_{init}$:
   - 冷启动: $q_{init} = 0$ 或远离 $q_{gt}$
   - 热启动: $q_{init}$ 接近 $q_{gt}$
4. 存储测试用例 $(T_{target}, q_{init}, q_{gt})$

**理由**: 确保目标位姿是可达的,便于验证求解器的正确性

## Risks / Trade-offs

### Risk 1: 生成的机器人可能不现实

**缓解**: 
- 限制链节长度在 [0.1, 0.5] 米
- 移动关节限制在 [-0.2, 0.5] 米(避免无限工作空间)
- 旋转轴交替使用 X/Y/Z 以确保空间复杂性

### Risk 2: 高 DOF (100+) 可能导致求解器失败或耗时过长

**缓解**: 
- 分层测试(10, 20, 50, 100 DOF),逐步增加复杂度
- 设置超时限制(如 1 秒)
- 使用热启动减少迭代次数
- 记录失败案例供后续分析

### Risk 3: Pinocchio 依赖增加环境配置复杂度

**缓解**: 
- 将 Pinocchio 作为可选依赖(仅用于数据生成,不影响运行时)
- 提供备选方案:使用 urdfx 自身的 Python 绑定作为 FK oracle
- 预生成数据集并版本控制,用户可直接使用

### Risk 4: 数据集文件可能过大

**缓解**: 
- 使用紧凑的二进制格式(如 NumPy .npz)或压缩 JSON
- 提供小型、中型、大型数据集供不同使用场景
- 不将数据集纳入主仓库(放在 LFS 或外部下载)

## Migration Plan

**Phase 1: 基础设施 (Week 1)**
1. 实现 `MixedChainGenerator` 类(Python)
2. 验证生成的 URDF 可被 urdfx 解析
3. 可视化示例机器人(使用 PyBullet 或 RViz)

**Phase 2: 数据集生成 (Week 2)**
4. 实现 FK oracle(urdfx Python 绑定或 Pinocchio)
5. 生成 Tier A 标准机器人基准数据集
6. 生成 Tier B 合成机器人数据集(10, 20, 50, 100 DOF)

**Phase 3: C++ 基准测试集成 (Week 3)**
7. 扩展 Google Benchmark 框架以支持可变 DOF
8. 实现数据集加载和测试执行
9. 生成报告和可视化结果

**Phase 4: 文档和验证 (Week 4)**
10. 编写用户指南和 API 文档
11. 运行端到端测试并验证结果
12. 发布初始版本

**Rollback**: 如果集成失败,保留现有基准测试不受影响,新的基准测试作为独立模块

## Open Questions

1. **Q**: 是否需要支持树形结构(多分支)的基准测试?  
   **A**: 当前版本仅支持单串行链,树形结构可作为未来扩展

2. **Q**: 是否需要测试不可达目标(位于工作空间外)?  
   **A**: 是的,添加"接近解"测试(最小化误差而非精确收敛)

3. **Q**: 基准测试结果如何与文献或其他库对比?  
   **A**: 提供标准数据集,鼓励社区提交其他求解器的结果进行对比

4. **Q**: 是否需要支持动态障碍物或碰撞避免?  
   **A**: 当前版本不支持,专注于运动学基准测试

